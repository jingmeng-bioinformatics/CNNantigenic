#! usr/bin/perl -w
use strict;
use lib "/home/pengyousong/backup/code/sequenceTool";
use tool;
use naiveBayesian2;


##	Feature : Site Groups
my @groups;
my %groups;
my $group_sites;
my $infile="epitope";
open(IN,"<$infile")||die "$!";
while(<IN>){
	chomp;
	next if(/^$/);
	next if(/^\#/);
	my @line=split(/\t/);
	my $group=shift @line;
	push(@groups,$group);
	push(@{$group_sites->{$group}},@line);
	foreach my$one(@line){
		$groups{$one}=$group;
	}
}
close(IN)||die "$!";
@groups=sort @groups;

##	AA characters
my @chars=qw(FASG890101 GRAR740103 ZIMJ680104 JANJ780101 CHAM820101); 
my $character; #$character->{index}->{aa}=value

$infile="aaIndex";
open(IN,"<$infile")||die "$!";
$_=<IN>;
chomp;
my @aa=split(/\t/);
shift @aa;
pop @aa;
while(<IN>){
	chomp;
	next if(/^$/);
	my @lineArray = split(/\t/);
	my $char=shift @lineArray;
	pop @lineArray;
	die "Bad line formate in file properties : $_\n" if($#lineArray != $#aa);
	for(my $i=0;$i<=$#aa;$i++){
		$character->{$char}->{$aa[$i]}=$lineArray[$i];
	}
}
close(IN)||die "$!";


##	Receptor Influence
my %receptor;
$infile="receptor_influence";
open(IN,"<$infile")||die "$!";
$_=<IN>;
my @arrayTem=split(/\t/);
die "Bad file formate in receptor influence : $_!\n" if( ($#arrayTem != 1) or ($arrayTem[0] != 0) );
while(<IN>){
	chomp;
	next if(/^$/);
	my @lineArray = split(/\t/);
	$receptor{ $lineArray[0] } = $arrayTem[1] - $lineArray[1];
}
close(IN)||die "$!";

#Read the glycosylated sites;
my $glyc={}; #$glyc->{sequence}=\@glycosylation sites
my $seqRef=readSeq("H1N1seq");
foreach my$id(keys %{$seqRef}){
	my $oneseq=join("",@{$seqRef->{$id}});
	my @pos=ngly($oneseq);
	push(@{$glyc->{$id}},@pos);
}

##	Dataset
print "Start Training ...\n";
my @train_antigenicity;
my @train_indexes;
print "Start storing dataset ...\n";
my $dataset=[]; #$dataset->[case index]=\@changes
$infile="seqCompare";
open(IN,"<$infile")||die "$!";
while(<IN>){
	chomp;
	next if(/^$/);
	my @lineArray = split(/\t/);
	die "Bad line formate in sequence comparison file : $_\n" if($#lineArray < 2);
	my $seqA=shift @lineArray;
	my $seqB=shift @lineArray;
	my $mark=shift @lineArray;
	my @new;  #
	foreach my$one(@lineArray){  #只考虑320以内的编号
		my $two=$one;
		$two=~s/[A-Z]//gi;
		my $temp=$one;
		$temp=~s/[0-9]//g;
		next if($temp=~/[^ACDEFGHIKLMNPQRSTVWY]/i);
		if($two <= 320){
			push(@new,$one);
		}
	}
	next if(scalar @new ==0);
	next if($mark ==0 && (scalar @new) >10);
	next if($mark ==1 && (scalar @new) < 3);

	push(@train_antigenicity,$mark);
	push(@train_indexes,$seqA."\t".$seqB );
	@{ $dataset->[$#train_antigenicity] }=@new;
}
close IN or die"$!";
print "Number of samples used in modeling: ",scalar @train_antigenicity,"\n";

##	Matrix
print "Start extract matrix...\n";
my $train_dataset;
my @attribute;

my $groups; #$groups->[group index]->[case index]=changed sites number
$groups=Groups($dataset,\@groups,\%groups);
for(my $i=0;$i<=$#{$groups};$i++){
	push(@attribute,$groups[$i]);
	@{$train_dataset->[$#attribute]}=@{$groups->[$i]};
}

my $chars; #$chars->[char index]->[case index]=changed aa character value
$chars=Chars($dataset,\@chars,$character);
for(my $i=0;$i<=$#{$chars};$i++){
	push(@attribute,$chars[$i]);
	@{$train_dataset->[$#attribute]}=@{$chars->[$i]};
}

my @receptor;
@receptor=Receptor($dataset,\%receptor);
push(@attribute,"receptor");
@{$train_dataset->[$#attribute]}=@receptor;

my @glyc;
@glyc=Glyc(\@train_indexes,$glyc);
push(@attribute,"glycosylation");
@{$train_dataset->[$#attribute]}=@glyc;
print "\tDataset done\n";

##	Cross Validation
print "Start Cross validation...\n";
my  ($accuracy,$sen,$spe,$predictRef,$obsRef) = CV2($train_dataset,5,@train_antigenicity);
print "5-fold-CV accuracy,sensitivity,specificity : $accuracy $sen $spe\n";


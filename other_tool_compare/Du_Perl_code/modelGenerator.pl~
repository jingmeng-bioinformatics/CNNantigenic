#! usr/bin/perl -w
use strict;
use naiveBayesian2;
use lib "/home/pengyousong/backup/code/sequenceTool";
use tool;

##	Feature : Site Groups
my @groups;
my %groups;
my $group_sites;

my $infile="epitope";
open(IN,"<$infile")||die "$!";
while(<IN>){
	chomp;
	next if(/^$/);
	next if(/^\#/);
	my @line=split(/\t/);
	my $group=shift @line;
	push(@groups,$group);
	push(@{$group_sites->{$group}},@line);
	foreach my$one(@line){
		$groups{$one}=$group;
	}
}
close(IN)||die "$!";
@groups=sort @groups;


##	AA characters
my @chars=qw(FASG890101 GRAR740103 ZIMJ680104 JANJ780101 CHAM820101); 
my $character; #$character->{index}->{aa}=value

$infile="aaIndex";
open(IN,"<$infile")||die "$!";
$_=<IN>;
chomp;
my @aa=split(/\t/);
shift @aa;
pop @aa;
while(<IN>){
	chomp;
	next if(/^$/);
	my @lineArray = split(/\t/);
	my $char=shift @lineArray;
	pop @lineArray;
	die "Bad line formate in file properties : $_\n" if($#lineArray != $#aa);
	for(my $i=0;$i<=$#aa;$i++){
		$character->{$char}->{$aa[$i]}=$lineArray[$i];
	}
}
close(IN)||die "$!";

##	Receptor Influence
my %receptor;
$infile="receptor_influence";
open(IN,"<$infile")||die "$!";
$_=<IN>;
my @arrayTem=split(/\s+/);
die "Bad file formate in receptor influence : $_!\n" if( ($#arrayTem != 1) or ($arrayTem[0] != 0) );

while(<IN>){
	chomp;
	next if(/^$/);
	my @lineArray = split(/\t/);
	$receptor{ $lineArray[0] } = $arrayTem[1] - $lineArray[1];
}
close(IN)||die "$!";

#Read the glycosylated sites;
my $glyc={}; #$glyc->{sequence}=\@glycosylation sites
my $seqRef=readSeq("H1N1seq");
foreach my$id(keys %{$seqRef}){
	my $oneseq=join("",@{$seqRef->{$id}});
	my @pos=ngly($oneseq);
	push(@{$glyc->{$id}},@pos);
}

##	Dataset
print "Start storing dataset ...\n";
my @antigenicity; #$train_antigenicity->{$substitution number}->[case index]=$value
my @indexes; #$train_indexes->{$substitution number}->[case index]=$pair

my $dataset=[]; #$dataset->[case index]=\@changes
$infile="seqCompare";
open(IN,"<$infile")||die "$!";
while(<IN>){
	chomp;
	next if(/^$/);
	my @lineArray = split(/\t/);
	die "Bad line formate in sequence comparison file : $_\n" if($#lineArray < 2);
	my $seqA=shift @lineArray;
	my $seqB=shift @lineArray;
	my $mark=shift @lineArray;

	my @new;  #
	foreach my$one(@lineArray){  #只考虑320以内的编号
		my $two=$one;
		$two=~s/[A-Z]//gi;
		my $temp=$one;
		$temp=~s/[0-9]//g;
		next if($temp=~/[^ACDEFGHIKLMNPQRSTVWY]/i);
		if($two <= 320){
			push(@new,$one);
		}
	}
	next if(scalar @new ==0);
	next if($mark ==0 && (scalar @new) >10);
	next if($mark ==1 && (scalar @new) < 3);

	push(@antigenicity,$mark);
	push(@indexes,$seqA."\t".$seqB );
	@{ $dataset->[$#antigenicity] }=@new;
}
close(IN)||die "$!";

my $change=0;
foreach(@antigenicity){
	$change+=$_;
}
my $prior=(1+$change)/(1+scalar(@antigenicity)-$change);  

##	Matrix
print "Start extract matrix...\n";
my $data;   #$data->[特征]->[所有病毒对在该特征上的改变]
my @attribute;

my $groups; #$groups->[group index]->[case index]=changed sites number。group即表位
$groups=Groups($dataset,\@groups,\%groups);
for(my $i=0;$i<=$#{$groups};$i++){
	push(@attribute,$groups[$i]);
	@{$data->[$#attribute]}=@{$groups->[$i]};
}


my $chars; #$chars->[char index]->[case index]=changed aa character value
$chars=Chars($dataset,\@chars,$character);
for(my $i=0;$i<=$#{$chars};$i++){
	push(@attribute,$chars[$i]);
	@{$data->[$#attribute]}=@{$chars->[$i]};
}

my @receptor;
@receptor=Receptor($dataset,\%receptor);
push(@attribute,"receptor");
@{$data->[$#attribute]}=@receptor;

my @glyc;
@glyc=Glyc(\@indexes,$glyc);
push(@attribute,"glycosylation");
@{$data->[$#attribute]}=@glyc;
print scalar @glyc,"\n";


##	Discretion
print "Start discretion...\n";
my @threshold = Discretion($data,@antigenicity);

##	Learning
print "Start parameter learning...\n";
my $distribution = NaiveBayesian($data,\@antigenicity,\@threshold);

##	Output Model
print "Start output model...\n";
my $outfile="model";
open(OUT,">$outfile")||die "$!";

#Output	Attribute:Group
print OUT "<Attribute:Group>\n";
foreach(@groups){
	print OUT "$_\t".join("\t",@{$group_sites->{$_}})."\n";
}
print OUT "//\n";

#Output	Attribute:Char
print OUT "<Attribute:Char>\n";
print OUT "AA\t".join("\t",@aa)."\n";
foreach my $one(@chars){
	print OUT "$one";
	foreach my $two(@aa){
		print OUT "\t$character->{$one}->{$two}";
	}
	print OUT "\n";
}
print OUT "//\n";

#Output	Attribute:Receptor
print OUT "<Attribute:Receptor>\n";
foreach(sort {$a <=> $b} keys %receptor){
	print OUT "$_\t$receptor{$_}\n";
}
print OUT "//\n";

#Output	Attribute:Glycosylation
print OUT "<Attribute:Glycosylation>\n//\n";

#Output	Parameter
print OUT "<Parameter>\n";
for(my $i=0;$i<=$#threshold;$i++){
	print OUT "$i\t$threshold[$i]\n";
}
print OUT "//\n";

#Output	Model
print OUT "<Model>\n";
print OUT "Prior\t$prior\n";
for(my $i=0;$i<=$#threshold;$i++){
	print OUT "$i\t$distribution->[$i]->[0]->[0]\t$distribution->[$i]->[0]->[1]\t$distribution->[$i]->[1]->[0]\t$distribution->[$i]->[1]->[1]\n";
}
print OUT "//\n";

close(OUT)||die "$!";
print "Done!\n";
